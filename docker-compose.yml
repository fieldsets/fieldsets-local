version: '3.7'
services:
    fieldsets-local:
        image: ${CONTAINER_REGISTRY:-fieldsets}/fieldsets-local:${FIELDSETS_LOCAL_VERSION:-latest}
        build:
            context: ./
            dockerfile: ${FIELDSETS_LOCAL_CONFIG_PATH:-./}Dockerfile
            args:
                TIMEZONE: ${TIMEZONE:-America/New_York}
                POSTGRES_VERSION: ${POSTGRES_VERSION:-15}
        container_name: fieldsets-local
        hostname: fieldsets-local
        tty: ${ENABLE_TERMINAL:-true}
        environment:
            ENVIRONMENT: ${ENVIRONMENT:-dev-local}
            LOGGER_HOST: ${LOGGER_HOST:-172.28.0.2}
            LOGGER_PORT: ${LOGGER_PORT:-24224}
            FIELDSETS_LOCAL_VERSION: ${FIELDSETS_LOCAL_VERSION:-latest}
            PUID: ${LOCAL_UID:-1000}
            PGID: ${LOCAL_GID:-1000}
            CLICKHOUSE_ENABLED: ${CLICKHOUSE_ENABLED:-false}
            CLICKHOUSE_HOST: ${CLICKHOUSE_HOST:-172.28.0.5}
            CLICKHOUSE_PORT: ${CLICKHOUSE_PORT:-8123}
            CLICKHOUSE_DB: ${CLICKHOUSE_DB:-fieldsets}
            CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
            CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-fieldsets}
            POSTGRES_VERSION: ${POSTGRES_VERSION:-15}
            POSTGRES_USER: ${POSTGRES_USER:-postgres}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fieldsets}
            POSTGRES_HOST: ${POSTGRES_HOST:-172.28.0.7}
            POSTGRES_DB: ${POSTGRES_DB:-fieldsets}
            POSTGRES_PORT: ${POSTGRES_PORT:-5432}
            POSTGRES_READER_ROLE: ${POSTGRES_READER_ROLE:-fieldsets_reader_role}
            POSTGRES_READER_ROLE_PASSWORD: ${POSTGRES_READER_ROLE_PASSWORD:-}
            POSTGRES_WRITER_ROLE: ${POSTGRES_WRITER_ROLE:-fieldsets_writer_role}
            POSTGRES_WRITER_ROLE_PASSWORD: ${POSTGRES_WRITER_ROLE_PASSWORD:-}
            POSTGRES_TRIGGER_ROLE: ${POSTGRES_TRIGGER_ROLE:-fieldsets_trigger_role}
            POSTGRES_TRIGGER_ROLE_PASSWORD: ${POSTGRES_TRIGGER_ROLE_PASSWORD:-}
            FIELDSETS_LOCAL_HOST: ${FIELDSETS_LOCAL_HOST:-172.28.0.6}
            SSH_HOST: ${SSH_HOST:-}
            SSH_PORT: ${SSH_PORT:-22}
            SSH_USER: ${SSH_USER:-}
            CHECKPOINT_PATH: ${CHECKPOINT_PATH:-/data/checkpoints/}
            DEBUG_MODE: ${DEBUG_MODE:-true}
            LOGGING_ENABLED: ${LOGGING_ENABLED:-false} # Write logs to DB
        volumes:
            - ${FIELDSETS_LOCAL_CONFIG_PATH:-./}apt-preferences:/etc/preferences
            - ${FIELDSETS_LOCAL_CONFIG_PATH:-./}.bashrc:/root/.bashrc
            - ${FIELDSETS_LOCAL_CONFIG_PATH:-./}.bash_profile:/root/.profile
            - ${FIELDSETS_LOCAL_CONFIG_PATH:-./}init/:/docker-entrypoint-init.d/
            - ${FIELDSETS_LOCAL_CONFIG_PATH:-./}sql/:/fieldsets-sql/
            - ${SSH_KEY_PATH:-~/.ssh/id_rsa}:/root/.ssh/id_rsa
            - ${FIELDSETS_LOCAL_CONFIG_PATH:-./}entrypoint.sh:/entrypoint.sh
            - ${FIELDSETS_LOCAL_CONFIG_PATH:-./}bin:/fieldsets-bin/
            - ${FIELDSETS_LIB_PATH:-./lib/}:/fieldsets-lib/
            - ${FIELDSETS_PLUGINS_PATH:-./plugins/}:/fieldsets-plugins/
            - ${FIELDSETS_SRC_PATH:-./src/}:/fieldsets/
            - local-data:/data        
        networks:
            default:
                ipv4_address: ${FIELDSETS_LOCAL_HOST:-172.28.0.6}
        logging:
            driver: fluentd
            options:
                fluentd-address: ${LOGGER_HOST:-172.28.0.2}:${LOGGER_PORT:-24224}
                tag: debug_log.local
                fluentd-async: "true"
                env: "PGOPTIONS='-c search_path=pipeline',LOGGING_ENABLED='${LOGGING_ENABLED:-false}'"
volumes:
    local-data:
        driver: local
        name: fieldsets-local-data

networks:
    default:
        driver: bridge
        name: fieldsets_network
        attachable: true
        ipam:
            config:
            - subnet: ${FIELDSETS_NETWORK_SUBNET:-172.28.0.0/24}

    